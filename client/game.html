<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="Shortcut icon" href="img/oznsgame.jpg" />
    <title>OZNS GAME</title>
    <meta name="author" content="Piotr Karaś" />
    <meta http-equiv="X-Ua-Compatible" content="IE=edge,chrome=1" />
    <link rel="stylesheet" href="style/style.css" type="text/css" />
</head>
<body>
    <div class="perspective">
        <div class="rotatebox">
            <div class="makegrey container bborder">
                <div class="nav xcbox box300">
                    <div class="flexbox">
                        <div class="menu">Menu</div>
                        <div class="aplayer"></div>->
                        <div class="nplayer"></div>
                    </div>
                </div>
                <div id="pngbox" class="xcbox ycbox box300"></div>
                <div id="board" class="ycbox xcbox box300 sborder">
                    <div id="canvbox">
                        <canvas id="c"></canvas>
                    </div>
                    <div class="flexbox"></div>
                </div>
                <div class="player xcbox box240 sborder">
                    <div class="flexbox">
                        <div id="canv" class="tile panel" onclick="showcanv()">L</div>
                        <div class="tile panel"></div>
                        <div id="turn" class="tile panel" onclick="nextturn()">T</div>
                        <div id="score" class="tile panel"></div>
                        <div class="tile letters" onclick="setlet(this)">O</div>
                        <div class="tile letters" onclick="setlet(this)">Z</div>
                        <div class="tile letters" onclick="setlet(this)">N</div>
                        <div class="tile letters" onclick="setlet(this)">S</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="sidenav sborder">
            <div class="tablerow">
                <button type="button">
                    <a class="blur" href="homepage.html">STRONA GŁÓWNA</a>
                </button>
            </div>
            <div class="players"></div>
            <div class="tablerow">
                <div class="rowname">GRACZE</div>
                <input class="dblur" type="number" value="2" disabled>
            </div>
            <div class="tablerow">
                <div class="rowname">ONZ</div>
                <input name="onz" type="checkbox" disabled>
            </div>
            <div class="tablerow">
                <div class="rowname">KOLOR</div>
                <input name="color" type="checkbox" disabled>
            </div>
            <div class="tablerow">
                <div class="rowname">COMBO</div>
                <input name="combo" type="checkbox" disabled>
            </div>
            <div class="tablerow">
                <div class="rowname">KARTY</div>
                <input name="cards" type="checkbox" disabled>
            </div>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
	<script src="socketiopack.js"></script>
	<!-- <script src="game.js"></script> -->
    <script>
        //INIT
        const background = "rgb(3, 0, 10)";
        var canvas = false;
        var mouse = {
            x: innerWidth/2,
            y: innerHeight/2,
        };
        var gameid = getCookie("gameid");
        var g;
        var pindex;

        if (gameid == null) window.location = "homepage.html";
        socket.emit('showGames',{
            all: false,
            index: gameid
        });
        socket.on('getGames', function(data){
            g = data.msg;
            let players = g.playersArray;
            let board = g.board;

            var y = 0;
            for(i=0; i<(board*board); i++){
                if((i%board)==0) y++;
                let x = (i%board)+1;
                let tilelet = g.tilesArray[i].l;
                $("#board > .flexbox").append('<div class="tile" name="x'+x+'y'+y+'" onclick="writelet('+x+','+y+')"></div>');
                if(tilelet!==undefined) {
                    let t = $("[name='x"+x+"y"+y+"']");
                    t.html(tilelet);
                    t.css('color', g.playersArray[g.tilesArray[i].p].c);
                }
            }
            
            $('.aplayer').html(players[g.turn].name);
            $('.aplayer').css('color', players[g.turn].c);
            if(g.turn+1==g.pn) nturn = 0;
            else nturn = g.turn+1;
            $('.nplayer').html(players[nturn].name);
            $('.nplayer').css('color', players[nturn].c);

            for(i=0; i<players.length; i++){
                $('.players').append('<div class="tablerow">'
                +'<div class="rowname" style="color: '+players[i].c+'">'+players[i].name+'</div>'
                +'<div id="p'+i+'" class="rowvalue" style="color: '+players[i].c+'">'+players[i].score+'</div>'
                +'</div>');

                if(players[i].id==pcid) {
                    pindex = i;
                    $('.letters').css('background-color', players[i].c);
                    $('#score').html(players[i].score);
                }
            }
            
            if(g.onz==true) $('input[name="onz"]').prop("checked", true);
            if(g.color==true) $('input[name="color"]').prop("checked", true);
            if(g.combo==true) $('input[name="combo"]').prop("checked", true);
            if(g.cards==true) $('input[name="cards"]').prop("checked", true);
        });
        socket.on('newLetter', function(data){
            let tile = $('.tile[name="x'+data.x+'y'+data.y+'"]');
            tile.html(data.l);
            tile.css('color', data.c);
            if(data.oom==true) $('#turn').css('background-color', g.playersArray[pindex].c);
        });
        socket.on('changeTurn', function(data){
            $('#turn').css('background-color', background);
            $('.aplayer').html(g.playersArray[data.aturn].name);
            $('.aplayer').css('color', g.playersArray[data.aturn].c);
            $('.nplayer').html(g.playersArray[data.nturn].name);
            $('.nplayer').css('color', g.playersArray[data.nturn].c);
            
            // g.dotsArray.length = dotsMax-4;

            if(data.aturn==pindex) play("yourturn");
        });
        socket.on('endGame', function(){
            $("#board > .flexbox").children(".tile").empty();
        });
        //FUNCTIONS
        function showcanv(){
            if(canvas==true) {
                $('#canv').css('background-color', background);
                $('#canvbox').css('display', 'none');
                canvas = false;
            } else {
                $('#canv').css('background-color', g.playersArray[pindex].c);
                $('#canvbox').css('display', 'block');
                canvas = true;
            }
        }
        function setlet(e){
            let l = $(e).text();
            if(l=="O" || l=="Z" || l=="N" || l=="S"){
                socket.emit('setLet',{
                    pindex: pindex,
                    gameid: gameid,
                    letter: l
                });
                $('.letters').css('background-color', g.playersArray[pindex].c);
                $(e).css('background-color', g.playersArray[pindex].dc);
            }
        }
        function writelet(x, y){
            socket.emit('writeLet',{
                pindex: pindex,
                gameid: gameid,
                x: x,
                y: y
            });
        }
        function nextturn(){
            socket.emit('nextTurn',{
                pindex: pindex,
                gameid: gameid
            });
        }
        function play(name){
            let box = $('#pngbox');
            box.html('<img class="ycbox" src="img/'+name+'.png">');
            setTimeout(function(){
                box.css({'z-index': '90', 'transform': 'translate(-50%, -50%) scale(1)'});
                setTimeout(function(){
                    box.css('transform', 'translate(-50%, -50%) scale(0.05)');
                    setTimeout(function(){
                        box.html('');
                        box.css('z-index', '-1');
                    },100);
                },1500);
            },100);
        }
    </script>
    <script>
        var rbox = $('.rotatebox');
        var gbox = $('.makegrey');
        $('.menu').click(function(){
            rbox.css('transform','rotateY(-45deg) translateX(35vw) translateZ(-35vw)');
            setTimeout(function(){gbox.addClass('hide')},100);
        });
        gbox.click(function(){
            if(gbox.hasClass('hide')){
                rbox.css('transform','rotateY(0)');
                gbox.removeClass('hide');
            }
        });
    </script>
</body>
</html>